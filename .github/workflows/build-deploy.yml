name: Build and Deploy

on:
  push:
    branches: ['main', 'development']
  workflow_dispatch:

env:
  OCI_REGISTRY: gru.ocir.io/grnvzpym0ltz
  OCI_USER: ${{ secrets.OCI_USERNAME }}
  OCI_PASS: ${{ secrets.OCI_TOKEN }}
  # URLs base
  APP_URL_BASE: app.fastconsig.com.br
  API_URL_BASE: api.fastconsig.com.br

jobs:
  # ============================================================================
  # BUILD & PUSH - Construir e Enviar Imagens Docker
  # ============================================================================
  build-and-push:
    name: Build & Push Images
    runs-on: [self-hosted, build]

    strategy:
      matrix:
        app: [api, web, jobs]

    steps:
      - name: Permiss√µes
        run: sudo chown -R $USER:$USER $GITHUB_WORKSPACE
        continue-on-error: true

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Build Context
        run: |
          # Short hash para tag
          IMAGE_TAG=$(git rev-parse --short HEAD)
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

          # Nome da imagem
          IMAGE_NAME="fastconsig-${{ matrix.app }}"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

          # Nome completo
          FULL_IMAGE_NAME="${{ env.OCI_REGISTRY }}/${IMAGE_NAME}:${IMAGE_TAG}"
          echo "FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV

      - name: Docker Login
        run: |
          echo "${{ env.OCI_PASS }}" | docker login ${{ env.OCI_REGISTRY }} -u "${{ env.OCI_USER }}" --password-stdin

      - name: Build and Push ${{ matrix.app }}
        run: |
          echo "üî® Buildando: ${{ env.FULL_IMAGE_NAME }}"

          # Build da imagem usando o Dockerfile espec√≠fico
          docker build \
            -f docker/Dockerfile.${{ matrix.app }} \
            -t ${{ env.FULL_IMAGE_NAME }} \
            --build-arg NODE_ENV=production \
            .

          # Push da imagem
          echo "üì§ Pushing: ${{ env.FULL_IMAGE_NAME }}"
          docker push ${{ env.FULL_IMAGE_NAME }}

          # Tag latest para o branch main
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            LATEST_TAG="${{ env.OCI_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            docker tag ${{ env.FULL_IMAGE_NAME }} $LATEST_TAG
            docker push $LATEST_TAG
          fi

      - name: Cleanup
        if: always()
        run: docker system prune -f

  # ============================================================================
  # DEPLOY - Deploy no Docker Swarm
  # ============================================================================
  deploy:
    name: Deploy to Swarm
    needs: build-and-push
    runs-on: [self-hosted, deploy]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Deploy Environment
        run: |
          # Short hash para tag
          export IMAGE_TAG=$(git rev-parse --short HEAD)
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

          REPO_NAME="fastconsig"
          BRANCH_NAME="${{ github.ref_name }}"

          # Define ambiente e stack
          if [[ "$BRANCH_NAME" == "main" ]]; then
            # Produ√ß√£o
            ENVIRONMENT="production"
            export NODE_ENV="production"
            export APP_URL="${{ env.APP_URL_BASE }}"
            export API_URL="${{ env.API_URL_BASE }}"
            export DB_NAME="fastconsig_prod"
          else
            # Development
            ENVIRONMENT="dev"
            export NODE_ENV="development"
            export APP_URL="dev-${{ env.APP_URL_BASE }}"
            export API_URL="dev-${{ env.API_URL_BASE }}"
            export DB_NAME="fastconsig_dev"
          fi

          export STACK_NAME="${REPO_NAME}-${ENVIRONMENT}"

          echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
          echo "NODE_ENV=$NODE_ENV" >> $GITHUB_ENV
          echo "APP_URL=$APP_URL" >> $GITHUB_ENV
          echo "API_URL=$API_URL" >> $GITHUB_ENV
          echo "DB_NAME=$DB_NAME" >> $GITHUB_ENV
          echo "STACK_NAME=$STACK_NAME" >> $GITHUB_ENV

      - name: Set Secrets
        env:
          DB_USER: fastconsig_prod
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          echo "DB_USER=$DB_USER" >> $GITHUB_ENV
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV
          echo "JWT_ACCESS_SECRET=$JWT_ACCESS_SECRET" >> $GITHUB_ENV
          echo "JWT_REFRESH_SECRET=$JWT_REFRESH_SECRET" >> $GITHUB_ENV
          echo "SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}" >> $GITHUB_ENV
          echo "SMTP_PORT=${SMTP_PORT:-587}" >> $GITHUB_ENV
          echo "SMTP_USER=$SMTP_USER" >> $GITHUB_ENV
          echo "SMTP_PASSWORD=$SMTP_PASSWORD" >> $GITHUB_ENV

      - name: Prepare Stack Files
        run: |
          TARGET_DIR="/swarm_data/deploy/${{ env.STACK_NAME }}"

          # Cria diret√≥rio se n√£o existir
          mkdir -p "$TARGET_DIR"

          # Copia arquivo da stack
          cp ops/fastconsig.yml "$TARGET_DIR/"

          echo "üìÅ Stack preparada em: $TARGET_DIR"

      - name: Run Database Migrations
        run: |
          echo "üóÑÔ∏è Executando migrations do Prisma..."

          # Temporariamente sobe um container para rodar migrations
          docker run --rm \
            --network ${STACK_NAME}_internal \
            -e DATABASE_URL="postgresql://${{ env.DB_USER }}:${{ env.DB_PASSWORD }}@postgres:5432/${{ env.DB_NAME }}" \
            ${{ env.OCI_REGISTRY }}/fastconsig-api:${{ env.IMAGE_TAG }} \
            npx prisma migrate deploy || echo "‚ö†Ô∏è Migrations falharam ou n√£o h√° migrations pendentes"

      - name: Deploy Stack
        run: |
          echo ""
          echo "=== üöÄ Iniciando Deploy ==="
          echo ""
          echo "Stack: ${{ env.STACK_NAME }}"
          echo "Ambiente: ${{ env.ENVIRONMENT }}"
          echo "Image Tag: ${{ env.IMAGE_TAG }}"
          echo "App URL: https://${{ env.APP_URL }}"
          echo "API URL: https://${{ env.API_URL }}"
          echo ""

          # Docker login
          echo "${{ env.OCI_PASS }}" | docker login ${{ env.OCI_REGISTRY }} -u "${{ env.OCI_USER }}" --password-stdin > /dev/null 2>&1

          # Deploy da stack
          cd "/swarm_data/deploy/${{ env.STACK_NAME }}"

          docker stack deploy \
            -c fastconsig.yml \
            "${{ env.STACK_NAME }}" \
            --with-registry-auth \
            --detach=true

          echo ""
          echo "‚úÖ Deploy conclu√≠do!"
          echo ""
          echo "üåê URLs:"
          echo "   App: https://${{ env.APP_URL }}"
          echo "   API: https://${{ env.API_URL }}"
          echo ""

      - name: Wait for Services
        run: |
          echo "‚è≥ Aguardando servi√ßos ficarem healthy..."
          sleep 30

          # Lista servi√ßos da stack
          docker stack services ${{ env.STACK_NAME }}

      - name: Health Check
        run: |
          echo "üè• Verificando sa√∫de dos servi√ßos..."

          # Verifica API
          curl -f https://${{ env.API_URL }}/health || echo "‚ö†Ô∏è API ainda n√£o est√° respondendo"

          # Verifica Web
          curl -f https://${{ env.APP_URL }} || echo "‚ö†Ô∏è Web ainda n√£o est√° respondendo"

      - name: Send Notification
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "‚úÖ Deploy de ${{ env.STACK_NAME }} realizado com sucesso!"
          else
            echo "‚ùå Deploy de ${{ env.STACK_NAME }} falhou!"
          fi
