// =============================================================================
// FastConsig - Prisma Schema
// Sistema de Gestao de Consignados
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// TENANT E CONFIGURACOES
// =============================================================================

model Tenant {
  id        Int      @id @default(autoincrement())
  nome      String   @db.VarChar(100)
  cnpj      String   @unique @db.VarChar(14)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Configuracoes
  configuracao TenantConfiguracao?

  // Relacionamentos
  empresas       Empresa[]
  funcionarios   Funcionario[]
  averbacoes     Averbacao[]
  usuarios       Usuario[]
  consignatarias TenantConsignataria[]
  conciliacoes   Conciliacao[]
  importacoes    Importacao[]
  auditoria      Auditoria[]

  @@map("tenant")
}

model TenantConfiguracao {
  id                    Int      @id @default(autoincrement())
  tenantId              Int      @unique @map("tenant_id")
  tenant                Tenant   @relation(fields: [tenantId], references: [id])
  percentualMargem      Decimal  @default(35) @map("percentual_margem") @db.Decimal(5, 2)
  percentualEmprestimo  Decimal  @default(30) @map("percentual_emprestimo") @db.Decimal(5, 2)
  percentualCartao      Decimal  @default(5) @map("percentual_cartao") @db.Decimal(5, 2)
  prazoMaximoMeses      Int      @default(96) @map("prazo_maximo_meses")
  idadeMaximaFimContrato Int     @default(75) @map("idade_maxima_fim_contrato")
  diasReservaMargemVence Int     @default(7) @map("dias_reserva_margem_vence")
  emailRemetente        String?  @map("email_remetente") @db.VarChar(100)
  smtpHost              String?  @map("smtp_host") @db.VarChar(100)
  smtpPort              Int?     @map("smtp_port")
  smtpUser              String?  @map("smtp_user") @db.VarChar(100)
  smtpPassword          String?  @map("smtp_password") @db.VarChar(255)
  smtpSecure            Boolean  @default(true) @map("smtp_secure")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("tenant_configuracao")
}

// =============================================================================
// EMPRESAS (Orgaos/Entidades)
// =============================================================================

model Empresa {
  id        Int           @id @default(autoincrement())
  tenantId  Int           @map("tenant_id")
  tenant    Tenant        @relation(fields: [tenantId], references: [id])
  codigo    String        @db.VarChar(10)
  nome      String        @db.VarChar(100)
  cnpj      String?       @db.VarChar(14)
  tipo      TipoEmpresa   @default(PREFEITURA)
  ativo     Boolean       @default(true)
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")

  funcionarios Funcionario[]

  @@unique([tenantId, codigo])
  @@index([tenantId])
  @@map("empresa")
}

enum TipoEmpresa {
  PREFEITURA
  AUTARQUIA
  CAMARA
  INSTITUTO_PREVIDENCIA
  FUNDACAO
  CONSORCIO
  OUTRO
}

// =============================================================================
// FUNCIONARIOS (Servidores)
// =============================================================================

model Funcionario {
  id              Int                 @id @default(autoincrement())
  tenantId        Int                 @map("tenant_id")
  tenant          Tenant              @relation(fields: [tenantId], references: [id])
  empresaId       Int                 @map("empresa_id")
  empresa         Empresa             @relation(fields: [empresaId], references: [id])
  cpf             String              @db.VarChar(11)
  nome            String              @db.VarChar(100)
  dataNascimento  DateTime            @map("data_nascimento") @db.Date
  sexo            Sexo?
  email           String?             @db.VarChar(100)
  telefone        String?             @db.VarChar(20)
  matricula       String              @db.VarChar(20)
  cargo           String?             @db.VarChar(100)
  dataAdmissao    DateTime            @map("data_admissao") @db.Date
  salarioBruto    Decimal             @map("salario_bruto") @db.Decimal(15, 2)
  situacao        SituacaoFuncionario @default(ATIVO)
  banco           String?             @db.VarChar(3)
  agencia         String?             @db.VarChar(10)
  conta           String?             @db.VarChar(20)
  tipoConta       TipoConta?          @map("tipo_conta")
  fotoUrl         String?             @map("foto_url") @db.VarChar(255)
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relacionamentos
  averbacoes          Averbacao[]
  margemHistorico     MargemHistorico[]
  funcionarioHistorico FuncionarioHistorico[]

  @@unique([tenantId, cpf])
  @@unique([tenantId, empresaId, matricula])
  @@index([tenantId])
  @@index([tenantId, situacao])
  @@index([tenantId, nome])
  @@map("funcionario")
}

enum Sexo {
  M
  F
}

enum SituacaoFuncionario {
  ATIVO
  INATIVO
  AFASTADO
  BLOQUEADO
  APOSENTADO
}

enum TipoConta {
  CORRENTE
  POUPANCA
  SALARIO
}

model FuncionarioHistorico {
  id             Int         @id @default(autoincrement())
  funcionarioId  Int         @map("funcionario_id")
  funcionario    Funcionario @relation(fields: [funcionarioId], references: [id])
  usuarioId      Int?        @map("usuario_id")
  usuario        Usuario?    @relation(fields: [usuarioId], references: [id])
  campo          String      @db.VarChar(50)
  valorAnterior  String?     @map("valor_anterior") @db.Text
  valorNovo      String?     @map("valor_novo") @db.Text
  motivo         String?     @db.VarChar(255)
  createdAt      DateTime    @default(now()) @map("created_at")

  @@index([funcionarioId])
  @@index([createdAt])
  @@map("funcionario_historico")
}

// =============================================================================
// MARGEM
// =============================================================================

model MargemHistorico {
  id              Int         @id @default(autoincrement())
  funcionarioId   Int         @map("funcionario_id")
  funcionario     Funcionario @relation(fields: [funcionarioId], references: [id])
  competencia     String      @db.VarChar(7) // MM/YYYY
  salarioBruto    Decimal     @map("salario_bruto") @db.Decimal(15, 2)
  margemTotal     Decimal     @map("margem_total") @db.Decimal(15, 2)
  margemUtilizada Decimal     @map("margem_utilizada") @db.Decimal(15, 2)
  margemDisponivel Decimal    @map("margem_disponivel") @db.Decimal(15, 2)
  createdAt       DateTime    @default(now()) @map("created_at")

  @@unique([funcionarioId, competencia])
  @@index([funcionarioId])
  @@map("margem_historico")
}

// =============================================================================
// CONSIGNATARIAS
// =============================================================================

model Consignataria {
  id           Int      @id @default(autoincrement())
  cnpj         String   @unique @db.VarChar(14)
  razaoSocial  String   @map("razao_social") @db.VarChar(100)
  nomeFantasia String?  @map("nome_fantasia") @db.VarChar(100)
  banco        String?  @db.VarChar(3)
  agencia      String?  @db.VarChar(10)
  conta        String?  @db.VarChar(20)
  email        String?  @db.VarChar(100)
  telefone     String?  @db.VarChar(20)
  endereco     String?  @db.VarChar(255)
  cidade       String?  @db.VarChar(100)
  uf           String?  @db.VarChar(2)
  cep          String?  @db.VarChar(8)
  ativo        Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  tenants      TenantConsignataria[]
  produtos     Produto[]
  usuarios     Usuario[]
  coeficientes TabelaCoeficiente[]

  @@map("consignataria")
}

model TenantConsignataria {
  id              Int           @id @default(autoincrement())
  tenantId        Int           @map("tenant_id")
  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  consignatariaId Int           @map("consignataria_id")
  consignataria   Consignataria @relation(fields: [consignatariaId], references: [id])
  codigo          String        @db.VarChar(10)
  dataInicioConvenio DateTime   @map("data_inicio_convenio") @db.Date
  dataFimConvenio    DateTime?  @map("data_fim_convenio") @db.Date
  limiteValor     Decimal?      @map("limite_valor") @db.Decimal(15, 2)
  limitePrazo     Int?          @map("limite_prazo")
  situacao        SituacaoConvenio @default(ATIVO)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  averbacoes Averbacao[]

  @@unique([tenantId, codigo])
  @@unique([tenantId, consignatariaId])
  @@index([tenantId])
  @@map("tenant_consignataria")
}

enum SituacaoConvenio {
  ATIVO
  SUSPENSO
  ENCERRADO
}

// =============================================================================
// PRODUTOS
// =============================================================================

model Produto {
  id              Int           @id @default(autoincrement())
  consignatariaId Int           @map("consignataria_id")
  consignataria   Consignataria @relation(fields: [consignatariaId], references: [id])
  codigo          String        @db.VarChar(10)
  nome            String        @db.VarChar(100)
  tipo            TipoProduto   @default(EMPRESTIMO)
  percentualMargem Decimal?     @map("percentual_margem") @db.Decimal(5, 2)
  prazoMinimo     Int?          @map("prazo_minimo")
  prazoMaximo     Int?          @map("prazo_maximo")
  valorMinimo     Decimal?      @map("valor_minimo") @db.Decimal(15, 2)
  valorMaximo     Decimal?      @map("valor_maximo") @db.Decimal(15, 2)
  ativo           Boolean       @default(true)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  averbacoes   Averbacao[]
  coeficientes TabelaCoeficiente[]

  @@unique([consignatariaId, codigo])
  @@map("produto")
}

enum TipoProduto {
  EMPRESTIMO
  CARTAO
  SEGURO
}

// =============================================================================
// TABELAS DE COEFICIENTES
// =============================================================================

model TabelaCoeficiente {
  id              Int           @id @default(autoincrement())
  consignatariaId Int           @map("consignataria_id")
  consignataria   Consignataria @relation(fields: [consignatariaId], references: [id])
  produtoId       Int           @map("produto_id")
  produto         Produto       @relation(fields: [produtoId], references: [id])
  nome            String        @db.VarChar(100)
  dataVigenciaInicio DateTime   @map("data_vigencia_inicio") @db.Date
  dataVigenciaFim    DateTime?  @map("data_vigencia_fim") @db.Date
  ativo           Boolean       @default(true)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  itens TabelaCoeficienteItem[]

  @@index([consignatariaId, produtoId])
  @@map("tabela_coeficiente")
}

model TabelaCoeficienteItem {
  id                  Int               @id @default(autoincrement())
  tabelaCoeficienteId Int               @map("tabela_coeficiente_id")
  tabelaCoeficiente   TabelaCoeficiente @relation(fields: [tabelaCoeficienteId], references: [id])
  prazo               Int
  coeficiente         Decimal           @db.Decimal(12, 10)
  taxaMensal          Decimal           @map("taxa_mensal") @db.Decimal(6, 4)
  taxaAnual           Decimal?          @map("taxa_anual") @db.Decimal(6, 4)

  @@unique([tabelaCoeficienteId, prazo])
  @@map("tabela_coeficiente_item")
}

// =============================================================================
// AVERBACOES
// =============================================================================

model Averbacao {
  id                  Int                 @id @default(autoincrement())
  tenantId            Int                 @map("tenant_id")
  tenant              Tenant              @relation(fields: [tenantId], references: [id])
  funcionarioId       Int                 @map("funcionario_id")
  funcionario         Funcionario         @relation(fields: [funcionarioId], references: [id])
  tenantConsignatariaId Int               @map("tenant_consignataria_id")
  tenantConsignataria TenantConsignataria @relation(fields: [tenantConsignatariaId], references: [id])
  produtoId           Int                 @map("produto_id")
  produto             Produto             @relation(fields: [produtoId], references: [id])
  numeroContrato      String              @map("numero_contrato") @db.VarChar(30)
  tipoOperacao        TipoOperacao        @default(NOVO) @map("tipo_operacao")
  situacao            SituacaoAverbacao   @default(AGUARDANDO_APROVACAO)
  valorTotal          Decimal             @map("valor_total") @db.Decimal(15, 2)
  valorLiquido        Decimal?            @map("valor_liquido") @db.Decimal(15, 2)
  valorParcela        Decimal             @map("valor_parcela") @db.Decimal(15, 2)
  parcelasTotal       Int                 @map("parcelas_total")
  parcelasPagas       Int                 @default(0) @map("parcelas_pagas")
  taxaMensal          Decimal             @map("taxa_mensal") @db.Decimal(6, 4)
  taxaAnual           Decimal?            @map("taxa_anual") @db.Decimal(6, 4)
  cetMensal           Decimal?            @map("cet_mensal") @db.Decimal(6, 4)
  cetAnual            Decimal?            @map("cet_anual") @db.Decimal(6, 4)
  iof                 Decimal?            @db.Decimal(15, 2)
  tac                 Decimal?            @db.Decimal(15, 2)
  saldoDevedor        Decimal?            @map("saldo_devedor") @db.Decimal(15, 2)
  dataContrato        DateTime            @map("data_contrato") @db.Date
  dataInicioDesconto  DateTime            @map("data_inicio_desconto") @db.Date
  dataFimDesconto     DateTime            @map("data_fim_desconto") @db.Date
  averbacaoVinculadaId Int?               @map("averbacao_vinculada_id")
  averbacaoVinculada  Averbacao?          @relation("AverbacaoVinculada", fields: [averbacaoVinculadaId], references: [id])
  averbacoesDependentes Averbacao[]       @relation("AverbacaoVinculada")
  motivoRejeicao      String?             @map("motivo_rejeicao") @db.Text
  observacao          String?             @db.Text
  usuarioCriacaoId    Int?                @map("usuario_criacao_id")
  usuarioCriacao      Usuario?            @relation("AverbacaoCriacao", fields: [usuarioCriacaoId], references: [id])
  usuarioAprovacaoId  Int?                @map("usuario_aprovacao_id")
  usuarioAprovacao    Usuario?            @relation("AverbacaoAprovacao", fields: [usuarioAprovacaoId], references: [id])
  dataAprovacao       DateTime?           @map("data_aprovacao")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  historico       AverbacaoHistorico[]
  conciliacaoItens ConciliacaoItem[]

  @@unique([tenantId, numeroContrato])
  @@index([tenantId])
  @@index([tenantId, situacao])
  @@index([tenantId, funcionarioId])
  @@index([tenantId, tenantConsignatariaId])
  @@index([tenantId, dataInicioDesconto])
  @@map("averbacao")
}

enum TipoOperacao {
  NOVO
  REFINANCIAMENTO
  COMPRA_DIVIDA
}

enum SituacaoAverbacao {
  AGUARDANDO_APROVACAO
  APROVADA
  REJEITADA
  ENVIADA
  DESCONTADA
  SUSPENSA
  BLOQUEADA
  LIQUIDADA
  CANCELADA
}

model AverbacaoHistorico {
  id            Int               @id @default(autoincrement())
  averbacaoId   Int               @map("averbacao_id")
  averbacao     Averbacao         @relation(fields: [averbacaoId], references: [id])
  situacaoAnterior SituacaoAverbacao? @map("situacao_anterior")
  situacaoNova  SituacaoAverbacao @map("situacao_nova")
  usuarioId     Int?              @map("usuario_id")
  usuario       Usuario?          @relation(fields: [usuarioId], references: [id])
  observacao    String?           @db.Text
  createdAt     DateTime          @default(now()) @map("created_at")

  @@index([averbacaoId])
  @@map("averbacao_historico")
}

// =============================================================================
// CONCILIACAO
// =============================================================================

model Conciliacao {
  id            Int                @id @default(autoincrement())
  tenantId      Int                @map("tenant_id")
  tenant        Tenant             @relation(fields: [tenantId], references: [id])
  competencia   String             @db.VarChar(7) // MM/YYYY
  status        StatusConciliacao  @default(ABERTA)
  totalEnviado  Decimal            @map("total_enviado") @db.Decimal(15, 2)
  totalDescontado Decimal          @map("total_descontado") @db.Decimal(15, 2)
  totalDivergente Decimal          @map("total_divergente") @db.Decimal(15, 2)
  qtdEnviados   Int                @map("qtd_enviados")
  qtdDescontados Int               @map("qtd_descontados")
  qtdDivergentes Int               @map("qtd_divergentes")
  dataFechamento DateTime?         @map("data_fechamento")
  usuarioFechamentoId Int?         @map("usuario_fechamento_id")
  usuarioFechamento Usuario?       @relation(fields: [usuarioFechamentoId], references: [id])
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  itens ConciliacaoItem[]

  @@unique([tenantId, competencia])
  @@index([tenantId])
  @@map("conciliacao")
}

enum StatusConciliacao {
  ABERTA
  EM_ANDAMENTO
  FECHADA
}

model ConciliacaoItem {
  id              Int               @id @default(autoincrement())
  conciliacaoId   Int               @map("conciliacao_id")
  conciliacao     Conciliacao       @relation(fields: [conciliacaoId], references: [id])
  averbacaoId     Int               @map("averbacao_id")
  averbacao       Averbacao         @relation(fields: [averbacaoId], references: [id])
  valorEnviado    Decimal           @map("valor_enviado") @db.Decimal(15, 2)
  valorDescontado Decimal           @map("valor_descontado") @db.Decimal(15, 2)
  status          StatusConciliacaoItem @default(CONFORME)
  motivo          String?           @db.VarChar(100)
  tratado         Boolean           @default(false)
  tratadoPor      Int?              @map("tratado_por")
  dataTratamento  DateTime?         @map("data_tratamento")
  observacao      String?           @db.Text
  createdAt       DateTime          @default(now()) @map("created_at")

  @@unique([conciliacaoId, averbacaoId])
  @@index([conciliacaoId])
  @@map("conciliacao_item")
}

enum StatusConciliacaoItem {
  CONFORME
  NAO_DESCONTADO
  PARCIAL
  DIVERGENTE
}

// =============================================================================
// IMPORTACAO/EXPORTACAO
// =============================================================================

model Importacao {
  id            Int              @id @default(autoincrement())
  tenantId      Int              @map("tenant_id")
  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  tipo          TipoImportacao
  nomeArquivo   String           @map("nome_arquivo") @db.VarChar(255)
  tamanhoBytes  Int              @map("tamanho_bytes")
  status        StatusImportacao @default(PENDENTE)
  totalLinhas   Int?             @map("total_linhas")
  linhasProcessadas Int?         @map("linhas_processadas")
  linhasSucesso Int?             @map("linhas_sucesso")
  linhasErro    Int?             @map("linhas_erro")
  erros         Json?
  usuarioId     Int              @map("usuario_id")
  usuario       Usuario          @relation(fields: [usuarioId], references: [id])
  iniciadoEm    DateTime?        @map("iniciado_em")
  finalizadoEm  DateTime?        @map("finalizado_em")
  createdAt     DateTime         @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([tenantId, status])
  @@map("importacao")
}

enum TipoImportacao {
  FUNCIONARIOS
  CONTRATOS
  RETORNO_FOLHA
}

enum StatusImportacao {
  PENDENTE
  PROCESSANDO
  CONCLUIDO
  ERRO
  CANCELADO
}

// =============================================================================
// USUARIOS E PERMISSOES
// =============================================================================

model Usuario {
  id              Int           @id @default(autoincrement())
  tenantId        Int?          @map("tenant_id")
  tenant          Tenant?       @relation(fields: [tenantId], references: [id])
  consignatariaId Int?          @map("consignataria_id")
  consignataria   Consignataria? @relation(fields: [consignatariaId], references: [id])
  perfilId        Int           @map("perfil_id")
  perfil          Perfil        @relation(fields: [perfilId], references: [id])
  nome            String        @db.VarChar(100)
  email           String        @unique @db.VarChar(100)
  login           String        @unique @db.VarChar(50)
  senhaHash       String        @map("senha_hash") @db.VarChar(255)
  ativo           Boolean       @default(true)
  primeiroAcesso  Boolean       @default(true) @map("primeiro_acesso")
  bloqueado       Boolean       @default(false)
  bloqueadoAte    DateTime?     @map("bloqueado_ate")
  tentativasLogin Int           @default(0) @map("tentativas_login")
  ultimoLogin     DateTime?     @map("ultimo_login")
  ultimoIp        String?       @map("ultimo_ip") @db.VarChar(45)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relacionamentos
  senhaHistorico       SenhaHistorico[]
  sessoes              Sessao[]
  passwordResetTokens  PasswordResetToken[]
  averbacoesCriadas    Averbacao[]            @relation("AverbacaoCriacao")
  averbacaoesAprovadas Averbacao[]            @relation("AverbacaoAprovacao")
  averbacaoHistorico   AverbacaoHistorico[]
  funcionarioHistorico FuncionarioHistorico[]
  importacoes          Importacao[]
  conciliacoesFechadas Conciliacao[]
  auditoria            Auditoria[]

  @@index([tenantId])
  @@index([consignatariaId])
  @@map("usuario")
}

model SenhaHistorico {
  id        Int      @id @default(autoincrement())
  usuarioId Int      @map("usuario_id")
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  senhaHash String   @map("senha_hash") @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([usuarioId])
  @@map("senha_historico")
}

model Sessao {
  id           Int      @id @default(autoincrement())
  usuarioId    Int      @map("usuario_id")
  usuario      Usuario  @relation(fields: [usuarioId], references: [id])
  refreshToken String   @unique @map("refresh_token") @db.VarChar(500)
  ip           String?  @db.VarChar(45)
  userAgent    String?  @map("user_agent") @db.VarChar(500)
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([usuarioId])
  @@index([expiresAt])
  @@map("sessao")
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  usuarioId Int      @map("usuario_id")
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  usado     Boolean  @default(false)
  usadoEm   DateTime? @map("usado_em")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([usuarioId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_token")
}

model Perfil {
  id          Int      @id @default(autoincrement())
  nome        String   @unique @db.VarChar(50)
  descricao   String?  @db.VarChar(255)
  tipo        TipoPerfil @default(CONSIGNANTE)
  ativo       Boolean  @default(true)
  sistema     Boolean  @default(false) // Perfis do sistema nao podem ser excluidos
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  usuarios    Usuario[]
  permissoes  PerfilPermissao[]

  @@map("perfil")
}

enum TipoPerfil {
  SISTEMA
  CONSIGNANTE
  CONSIGNATARIA
  AGENTE
}

model Permissao {
  id        Int      @id @default(autoincrement())
  codigo    String   @unique @db.VarChar(50)
  nome      String   @db.VarChar(100)
  modulo    String   @db.VarChar(50)
  descricao String?  @db.VarChar(255)

  perfis PerfilPermissao[]

  @@map("permissao")
}

model PerfilPermissao {
  id          Int       @id @default(autoincrement())
  perfilId    Int       @map("perfil_id")
  perfil      Perfil    @relation(fields: [perfilId], references: [id])
  permissaoId Int       @map("permissao_id")
  permissao   Permissao @relation(fields: [permissaoId], references: [id])

  @@unique([perfilId, permissaoId])
  @@map("perfil_permissao")
}

// =============================================================================
// AUDITORIA
// =============================================================================

model Auditoria {
  id          Int      @id @default(autoincrement())
  tenantId    Int?     @map("tenant_id")
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  usuarioId   Int?     @map("usuario_id")
  usuario     Usuario? @relation(fields: [usuarioId], references: [id])
  entidade    String   @db.VarChar(50)
  entidadeId  Int?     @map("entidade_id")
  acao        AcaoAuditoria
  dadosAnteriores Json? @map("dados_anteriores")
  dadosNovos  Json?    @map("dados_novos")
  ip          String?  @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@index([usuarioId])
  @@index([entidade, entidadeId])
  @@index([createdAt])
  @@map("auditoria")
}

enum AcaoAuditoria {
  CRIAR
  ATUALIZAR
  EXCLUIR
  LOGIN
  LOGOUT
  APROVAR
  REJEITAR
  SUSPENDER
  CANCELAR
  IMPORTAR
  EXPORTAR
}

// =============================================================================
// NOTIFICACOES
// =============================================================================

model Notificacao {
  id          Int             @id @default(autoincrement())
  usuarioId   Int             @map("usuario_id")
  tipo        TipoNotificacao
  titulo      String          @db.VarChar(100)
  mensagem    String          @db.Text
  lida        Boolean         @default(false)
  link        String?         @db.VarChar(255)
  createdAt   DateTime        @default(now()) @map("created_at")

  @@index([usuarioId, lida])
  @@index([createdAt])
  @@map("notificacao")
}

enum TipoNotificacao {
  INFO
  ALERTA
  ERRO
  SUCESSO
  AVERBACAO_PENDENTE
  AVERBACAO_APROVADA
  AVERBACAO_REJEITADA
}
